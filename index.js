import express from "express";
import axios from "axios";
import fs from "fs";

const app = express();
app.use(express.json());

const LINE_ACCESS_TOKEN = process.env.LINE_ACCESS_TOKEN;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const ADMIN_SECRET = process.env.ADMIN_SECRET || "yuj-secret";

// JSONãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
const USERS_FILE = "./users.json";
const BACKUP_DIR = "./backups";

// åˆæœŸåŒ–
if (!fs.existsSync(USERS_FILE)) fs.writeFileSync(USERS_FILE, JSON.stringify({}));
if (!fs.existsSync(BACKUP_DIR)) fs.mkdirSync(BACKUP_DIR);

// =======================
// 52é€±åˆ†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
// =======================
const weeklyMessages = [
  { keyword: "ã¯ã˜ã¾ã‚Š", message: "å°ã•ãªä¸€æ­©ã‚’è¸ã¿å‡ºã™æœã€‚æ·±å‘¼å¸ã‹ã‚‰ã€ä»Šé€±ã‚’å§‹ã‚ã‚ˆã†ã€‚", breath: { name: "ã‚¹ã‚¿ãƒ¼ãƒˆå‘¼å¸", guide: "3ç§’å¸ã£ã¦ã€6ç§’åãã€‚ä½“ã®ä¸­å¿ƒã«æˆ»ã‚‹ã‚ˆã†ã«ã€‚" } },
  { keyword: "ä½™ç™½", message: "è©°ã‚è¾¼ã¿ã™ãŽãšã€ç©ºç™½ã‚’æ®‹ãã†ã€‚å‘¼å¸ã®éš™é–“ã«ã‚„ã•ã—ã•ãŒã‚ã‚‹ã€‚", breath: { name: "ä½™ç™½å‘¼å¸", guide: "å¸ã†ãŸã³èƒ¸ã®å¥¥ã«ç©ºã‚’ã¤ãã‚ã†ã€‚" } },
  { keyword: "æŸ”ã‚‰ã‹ã•", message: "ã†ã¾ãã„ã‹ãªãã¦ã‚‚å¤§ä¸ˆå¤«ã€‚ã‚„ã‚ã‚‰ã‹ã„å‘¼å¸ã§ã€ä»Šæ—¥ã‚’è¿Žãˆã‚ˆã†ã€‚", breath: { name: "ã‚„ã‚ã‚‰ãŽå‘¼å¸", guide: "å¸ã£ã¦åºƒã’ã€åã„ã¦æº¶ã‘ã‚‹ã‚ˆã†ã«ã€‚" } },
  { keyword: "æ•´ãˆã‚‹", message: "ã‚ã‚Œã‚‚ã“ã‚Œã‚‚æ‰‹æ”¾ã—ã¦ã€å‘¼å¸ã ã‘ã«æ„è­˜ã‚’æˆ»ãã†ã€‚", breath: { name: "æ•´ã†å‘¼å¸", guide: "å¸ã£ã¦å§¿å‹¢ã‚’ä¼¸ã°ã—ã€åã„ã¦æ•´ã†ã€‚" } },
  { keyword: "å…‰", message: "æœã®å…‰ã‚’èƒ¸ã«å–ã‚Šè¾¼ã¿ã€å¿ƒã‚’æ˜Žã‚‹ãä¿ã¨ã†ã€‚", breath: { name: "å…‰å‘¼å¸", guide: "å¸ã£ã¦èƒ¸ã‚’åºƒã’ã€åã„ã¦å¿ƒã‚’ç…§ã‚‰ãã†ã€‚" } },
  { keyword: "æ¸©ã‚‚ã‚Š", message: "ä½“ã®ä¸­å¿ƒã«ã¬ãã‚‚ã‚Šã‚’æ„Ÿã˜ã¦ã€ã»ã£ã¨ä¸€æ¯ã€‚", breath: { name: "ã¬ãã‚‚ã‚Šå‘¼å¸", guide: "å¸ã£ã¦æ¸©ã‹ã•ã‚’å–ã‚Šè¾¼ã¿ã€åã„ã¦ä½“ã«åºƒã’ã‚ˆã†ã€‚" } },
  { keyword: "æŸ”è»Ÿ", message: "è‚©ã®åŠ›ã‚’æŠœãã€å¿ƒã‚‚ä½“ã‚‚æŸ”ã‚‰ã‹ãã€‚", breath: { name: "æŸ”è»Ÿå‘¼å¸", guide: "å¸ã†ã¨ãã«ä½“ã‚’åºƒã’ã€åãã¨ãã«ã‚†ã‚‹ã‚ã‚ˆã†ã€‚" } },
  { keyword: "ç©ã‚„ã‹", message: "å¿ƒã«æ³¢ãŒã‚ã£ã¦ã‚‚å¤§ä¸ˆå¤«ã€‚å‘¼å¸ã¨ã¨ã‚‚ã«æ•´ãˆã‚ˆã†ã€‚", breath: { name: "ç©ã‚„ã‹å‘¼å¸", guide: "å¸ã£ã¦è½ã¡ç€ãã‚’æ„Ÿã˜ã€åã„ã¦å¿ƒã‚’éŽ®ã‚ã‚ˆã†ã€‚" } },
  { keyword: "é›†ä¸­", message: "ä»Šã“ã®çž¬é–“ã«æ„è­˜ã‚’å‘ã‘ã€å‘¼å¸ã‚’æ„Ÿã˜ã‚ˆã†ã€‚", breath: { name: "é›†ä¸­å‘¼å¸", guide: "å¸ã£ã¦æ„è­˜ã‚’é›†ã‚ã€åã„ã¦ä½™è¨ˆãªæ€ã„ã‚’æ‰‹æ”¾ãã†ã€‚" } },
  { keyword: "å·¡ã‚Š", message: "ä½“ã¨å¿ƒã®å·¡ã‚Šã‚’æ„Ÿã˜ã€ãƒªã‚ºãƒ ã«åˆã‚ã›ã‚ˆã†ã€‚", breath: { name: "å·¡ã‚Šå‘¼å¸", guide: "å¸ã£ã¦ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’é›†ã‚ã€åã„ã¦å…¨èº«ã«å·¡ã‚‰ã›ã‚ˆã†ã€‚" } },
  { keyword: "æ·±ã‚ã‚‹", message: "å‘¼å¸ã‚’æ·±ãã—ã¦ã€ä½“ã®å¥¥ã¾ã§ã‚†ã£ãŸã‚Šã¨ã€‚", breath: { name: "æ·±å‘¼å¸", guide: "å¸ã£ã¦æ·±ãå–ã‚Šè¾¼ã¿ã€åã„ã¦ã—ã£ã‹ã‚Šå‡ºãã†ã€‚" } },
  { keyword: "ä¼¸ã³ã‚„ã‹", message: "ä½“ã‚‚å¿ƒã‚‚ã€ã®ã³ã‚„ã‹ã«é€±ã‚’ã¯ã˜ã‚ã‚ˆã†ã€‚", breath: { name: "ä¼¸ã³å‘¼å¸", guide: "å¸ã£ã¦èƒŒç­‹ã‚’ä¼¸ã°ã—ã€åã„ã¦å…¨èº«ã‚’è§£æ”¾ã—ã‚ˆã†ã€‚" } },
  { keyword: "é™ã‘ã•", message: "å‘¨ã‚Šã®éŸ³ã«æŒ¯ã‚Šå›žã•ã‚Œãšã€è‡ªåˆ†ã®å‘¼å¸ã«æˆ»ã‚ã†ã€‚", breath: { name: "é™ã‘ã•å‘¼å¸", guide: "å¸ã£ã¦é™ã‹ã«ã€åã„ã¦è½ã¡ç€ãã‚’æ„Ÿã˜ã‚ˆã†ã€‚" } },
  { keyword: "è»½ã‚„ã‹", message: "å¿ƒã‚’è»½ãã—ã¦ã€å‹•ãã‚„ã™ã„é€±ã«ã—ã‚ˆã†ã€‚", breath: { name: "è»½ã‚„ã‹å‘¼å¸", guide: "å¸ã£ã¦èƒ¸ã‚’åºƒã’ã€åã„ã¦ä½“ã‚’è»½ãæ„Ÿã˜ã‚ˆã†ã€‚" } },
  { keyword: "å®‰å®š", message: "è¶³å…ƒã‚’æ„Ÿã˜ã€å¿ƒã‚‚ä½“ã‚‚å®‰å®šã•ã›ã‚ˆã†ã€‚", breath: { name: "å®‰å®šå‘¼å¸", guide: "å¸ã£ã¦åœ°é¢ã«åŠ›ã‚’é€ã‚Šã€åã„ã¦å®‰å¿ƒæ„Ÿã‚’åºƒã’ã‚ˆã†ã€‚" } },
  { keyword: "å–œã³", message: "å°ã•ãªã“ã¨ã«ã‚‚å–œã³ã‚’è¦‹ã¤ã‘ã¦ã€ç¬‘é¡”ã‚’å¢—ã‚„ãã†ã€‚", breath: { name: "å–œã³å‘¼å¸", guide: "å¸ã£ã¦èƒ¸ã‚’é–‹ãã€åã„ã¦ç¬‘é¡”ã‚’åºƒã’ã‚ˆã†ã€‚" } },
  { keyword: "å„ªã—ã•", message: "è‡ªåˆ†ã«ã‚‚å‘¨ã‚Šã«ã‚‚å„ªã—ã„æ°—æŒã¡ã‚’ã€‚", breath: { name: "å„ªã—ã•å‘¼å¸", guide: "å¸ã£ã¦ã‚„ã•ã—ã•ã‚’å–ã‚Šè¾¼ã¿ã€åã„ã¦åˆ†ã‘ä¸Žãˆã‚ˆã†ã€‚" } },
  { keyword: "è‡ªä¿¡", message: "å‘¼å¸ã¨ã¨ã‚‚ã«è‡ªåˆ†ã®åŠ›ã‚’ä¿¡ã˜ã¦æ­©ã“ã†ã€‚", breath: { name: "è‡ªä¿¡å‘¼å¸", guide: "å¸ã£ã¦èƒ¸ã‚’å¼µã‚Šã€åã„ã¦åŠ›ã‚’æ•´ãˆã‚ˆã†ã€‚" } },
  { keyword: "å®‰å¿ƒ", message: "å®‰å¿ƒã§ãã‚‹å ´æ‰€ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã¦ã€å¿ƒã‚’è½ã¡ç€ã‘ã‚ˆã†ã€‚", breath: { name: "å®‰å¿ƒå‘¼å¸", guide: "å¸ã£ã¦å®ˆã‚‰ã‚Œã¦ã„ã‚‹ã¨æ„Ÿã˜ã€åã„ã¦å®‰ã‚‰ãŽã‚’åºƒã’ã‚ˆã†ã€‚" } },
  { keyword: "å¸Œæœ›", message: "æœªæ¥ã‚’æ€ã„æãã€å‘¼å¸ã¨ã¨ã‚‚ã«åŠ›ã‚’é€ã‚ã†ã€‚", breath: { name: "å¸Œæœ›å‘¼å¸", guide: "å¸ã£ã¦å¸Œæœ›ã‚’èƒ¸ã«å–ã‚Šè¾¼ã¿ã€åã„ã¦å…¨èº«ã«åºƒã’ã‚ˆã†ã€‚" } },
  { keyword: "å¤‰åŒ–", message: "å¤‰åŒ–ã¯è‡ªç„¶ãªã“ã¨ã€‚å‘¼å¸ã§å¿ƒã‚’æŸ”ã‚‰ã‹ãã€‚", breath: { name: "å¤‰åŒ–å‘¼å¸", guide: "å¸ã£ã¦å¿ƒã‚’é–‹ãã€åã„ã¦å¤‰åŒ–ã‚’å—ã‘å…¥ã‚Œã‚ˆã†ã€‚" } },
  { keyword: "è§£æ”¾", message: "ä¸è¦ãªç·Šå¼µã‚’æ‰‹æ”¾ã—ã¦ã€ä½“ã‚‚å¿ƒã‚‚è‡ªç”±ã«ã€‚", breath: { name: "è§£æ”¾å‘¼å¸", guide: "å¸ã£ã¦ä½“ã‚’åºƒã’ã€åã„ã¦ç·Šå¼µã‚’å‡ºãã†ã€‚" } },
  { keyword: "ã¤ãªãŒã‚Š", message: "è‡ªåˆ†ã¨å‘¼å¸ã€ãã—ã¦ä¸–ç•Œã¨ã¤ãªãŒã‚‹æ„Ÿè¦šã‚’å‘³ã‚ãŠã†ã€‚", breath: { name: "ã¤ãªãŒã‚Šå‘¼å¸", guide: "å¸ã£ã¦æ„è­˜ã‚’åºƒã’ã€åã„ã¦å¿ƒã‚’ã¤ãªã’ã‚ˆã†ã€‚" } },
  { keyword: "æˆé•·", message: "å°‘ã—ãšã¤ã§ã‚‚æˆé•·ã—ã¦ã„ã‚‹è‡ªåˆ†ã‚’èªã‚ã‚ˆã†ã€‚", breath: { name: "æˆé•·å‘¼å¸", guide: "å¸ã£ã¦åŠ›ã‚’å–ã‚Šè¾¼ã¿ã€åã„ã¦è‚²ã¦ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã€‚" } },
  { keyword: "æŸ”è»Ÿæ€§", message: "å¿ƒã‚‚ä½“ã‚‚æŸ”è»Ÿã«ã€æµã‚Œã«èº«ã‚’ä»»ã›ã‚ˆã†ã€‚", breath: { name: "æŸ”è»Ÿæ€§å‘¼å¸", guide: "å¸ã£ã¦åºƒã’ã€åã„ã¦æŸ”ã‚‰ã‹ãåŒ…ã‚‚ã†ã€‚" } },
  { keyword: "å‰å‘ã", message: "å°ã•ãªå‰é€²ã‚’ç©ã¿é‡ã­ã¦ã€å‰å‘ãã«éŽã”ãã†ã€‚", breath: { name: "å‰å‘ãå‘¼å¸", guide: "å¸ã£ã¦åŠ›ã‚’é›†ã‚ã€åã„ã¦å‰ã¸æŠ¼ã—å‡ºãã†ã€‚" } },
  { keyword: "æ„Ÿè¬", message: "ä»Šã‚ã‚‹ã“ã¨ã«æ„Ÿè¬ã—ã€å‘¼å¸ã«æ„è­˜ã‚’å‘ã‘ã‚ˆã†ã€‚", breath: { name: "æ„Ÿè¬å‘¼å¸", guide: "å¸ã£ã¦æ„Ÿè¬ã‚’æ„Ÿã˜ã€åã„ã¦å¿ƒã«åºƒã’ã‚ˆã†ã€‚" } },
  { keyword: "å¹³å’Œ", message: "ç©ã‚„ã‹ãªå¿ƒã§é€±ã‚’è¿Žãˆã‚ˆã†ã€‚", breath: { name: "å¹³å’Œå‘¼å¸", guide: "å¸ã£ã¦å¿ƒã‚’è½ã¡ç€ã‘ã€åã„ã¦å¹³å’Œã‚’åºƒã’ã‚ˆã†ã€‚" } },
  { keyword: "å‹‡æ°—", message: "æ€–ã•ã‚’æ„Ÿã˜ã¦ã‚‚ã€å‘¼å¸ã¨ã¨ã‚‚ã«ä¸€æ­©ã‚’è¸ã¿å‡ºãã†ã€‚", breath: { name: "å‹‡æ°—å‘¼å¸", guide: "å¸ã£ã¦åŠ›ã‚’èƒ¸ã«é›†ã‚ã€åã„ã¦å‰ã«è¸ã¿å‡ºãã†ã€‚" } },
  { keyword: "èª¿å’Œ", message: "ä½“ã¨å¿ƒã®èª¿å’Œã‚’æ„Ÿã˜ã¦éŽã”ãã†ã€‚", breath: { name: "èª¿å’Œå‘¼å¸", guide: "å¸ã£ã¦æ•´ãˆã€åã„ã¦ãƒãƒ©ãƒ³ã‚¹ã‚’ä¿ã¨ã†ã€‚" } },
  { keyword: "å–œã³ã®å¾ªç’°", message: "å°ã•ãªå–œã³ã‚’å‘¼å¸ã«ä¹—ã›ã¦å¾ªç’°ã•ã›ã‚ˆã†ã€‚", breath: { name: "å¾ªç’°å‘¼å¸", guide: "å¸ã£ã¦å–œã³ã‚’å–ã‚Šè¾¼ã¿ã€åã„ã¦åºƒã’ã‚ˆã†ã€‚" } },
  { keyword: "æ˜Žã‚‹ã•", message: "æœã®å…‰ã®ã‚ˆã†ã«ã€å¿ƒã‚’æ˜Žã‚‹ãç…§ã‚‰ãã†ã€‚", breath: { name: "æ˜Žã‚‹ã•å‘¼å¸", guide: "å¸ã£ã¦å…‰ã‚’å–ã‚Šè¾¼ã¿ã€åã„ã¦å…¨èº«ã«åºƒã’ã‚ˆã†ã€‚" } },
  { keyword: "é›†ä¸­åŠ›", message: "ä»Šã“ã“ã«æ„è­˜ã‚’é›†ä¸­ã•ã›ã¦ã€å‘¼å¸ã‚’æ„Ÿã˜ã‚ˆã†ã€‚", breath: { name: "é›†ä¸­åŠ›å‘¼å¸", guide: "å¸ã£ã¦æ„è­˜ã‚’é›†ã‚ã€åã„ã¦ä½™è¨ˆãªè€ƒãˆã‚’æ‰‹æ”¾ãã†ã€‚" } },
  { keyword: "å¸Œæœ›ã®å…‰", message: "æœªæ¥ã®å¸Œæœ›ã‚’å‘¼å¸ã§èƒ¸ã«ç¯ãã†ã€‚", breath: { name: "å¸Œæœ›ã®å…‰å‘¼å¸", guide: "å¸ã£ã¦å¸Œæœ›ã‚’å–ã‚Šè¾¼ã¿ã€åã„ã¦ä½“ã«åºƒã’ã‚ˆã†ã€‚" } },
  { keyword: "ã‚„ã•ã—ã•ã®æ³¢", message: "ã‚„ã•ã—ã„æ°—æŒã¡ã‚’å‘¼å¸ã«ä¹—ã›ã¦åºƒã’ã‚ˆã†ã€‚", breath: { name: "ã‚„ã•ã—ã•å‘¼å¸", guide: "å¸ã£ã¦å¿ƒã«ã‚„ã•ã—ã•ã‚’å–ã‚Šè¾¼ã¿ã€åã„ã¦å‘¨ã‚Šã«åºƒã’ã‚ˆã†ã€‚" } },
  { keyword: "å®‰ã‚‰ãŽ", message: "æ·±ã„å‘¼å¸ã§å®‰ã‚‰ãŽã‚’å–ã‚Šæˆ»ãã†ã€‚", breath: { name: "å®‰ã‚‰ãŽå‘¼å¸", guide: "å¸ã£ã¦è½ã¡ç€ãã‚’æ„Ÿã˜ã€åã„ã¦å¿ƒã‚’ä¼‘ã‚ã‚ˆã†ã€‚" } },
  { keyword: "æŸ”ã‚‰ã‹ãªå…‰", message: "æœã®æŸ”ã‚‰ã‹ã„å…‰ã®ã‚ˆã†ã«ã€å‘¼å¸ã‚’æ„Ÿã˜ã‚ˆã†ã€‚", breath: { name: "æŸ”ã‚‰ã‹å…‰å‘¼å¸", guide: "å¸ã£ã¦æŸ”ã‚‰ã‹ã•ã‚’å–ã‚Šè¾¼ã¿ã€åã„ã¦å¿ƒã«ç¯ãã†ã€‚" } },
  { keyword: "å‰é€²", message: "å°ã•ãªå‰é€²ã‚‚å¤§åˆ‡ã«ã€å‘¼å¸ã§èƒŒä¸­ã‚’æŠ¼ãã†ã€‚", breath: { name: "å‰é€²å‘¼å¸", guide: "å¸ã£ã¦åŠ›ã‚’é›†ã‚ã€åã„ã¦å‰ã«é€²ã‚ã‚ˆã†ã€‚" } },
  { keyword: "èª¿æ•´", message: "å‘¼å¸ã¨ã¨ã‚‚ã«ä½“ã¨å¿ƒã‚’èª¿æ•´ã—ã‚ˆã†ã€‚", breath: { name: "èª¿æ•´å‘¼å¸", guide: "å¸ã£ã¦æ•´ãˆã€åã„ã¦ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚ã†ã€‚" } },
  { keyword: "å¸Œæœ›ã®æ¯", message: "å¸Œæœ›ã‚’èƒ¸ã«å‘¼å¸ã‚’é€šã—ã¦å–ã‚Šè¾¼ã‚‚ã†ã€‚", breath: { name: "å¸Œæœ›å‘¼å¸", guide: "å¸ã£ã¦å¸Œæœ›ã‚’å–ã‚Šè¾¼ã¿ã€åã„ã¦å…¨èº«ã«åºƒã’ã‚ˆã†ã€‚" } },
  { keyword: "å…‰ã¨é¢¨", message: "å…‰ã¨é¢¨ã‚’æ„Ÿã˜ãªãŒã‚‰æ·±å‘¼å¸ã—ã‚ˆã†ã€‚", breath: { name: "å…‰é¢¨å‘¼å¸", guide: "å¸ã£ã¦å…‰ã‚’èƒ¸ã«ã€åã„ã¦é¢¨ã‚’å…¨èº«ã«é€šãã†ã€‚" } },
  { keyword: "è‡ªç„¶ä½“", message: "è‡ªç„¶ä½“ã§å‘¼å¸ã—ã€è‡ªåˆ†ã‚’å—ã‘å…¥ã‚Œã‚ˆã†ã€‚", breath: { name: "è‡ªç„¶ä½“å‘¼å¸", guide: "å¸ã£ã¦ä½“ã‚’æ„Ÿã˜ã€åã„ã¦å¿ƒã‚‚ç·©ã‚ã‚ˆã†ã€‚" } },
  { keyword: "æ„Ÿè¬ã®æ¯", message: "æ„Ÿè¬ã®æ°—æŒã¡ã‚’å‘¼å¸ã«ä¹—ã›ã‚ˆã†ã€‚", breath: { name: "æ„Ÿè¬å‘¼å¸", guide: "å¸ã£ã¦ã‚ã‚ŠãŒã¨ã†ã‚’èƒ¸ã«ã€åã„ã¦å…¨èº«ã«åºƒã’ã‚ˆã†ã€‚" } },
  { keyword: "å®‰å®šã®æ³¢", message: "å‘¼å¸ã®æ³¢ã«èº«ã‚’å§”ã­ã€å¿ƒã‚’å®‰å®šã•ã›ã‚ˆã†ã€‚", breath: { name: "å®‰å®šå‘¼å¸", guide: "å¸ã£ã¦æ³¢ã‚’æ„Ÿã˜ã€åã„ã¦å¿ƒã‚’æ•´ãˆã‚ˆã†ã€‚" } },
  { keyword: "æ¸…ã€…ã—ã•", message: "æ–°é®®ãªç©ºæ°—ã®ã‚ˆã†ã«å‘¼å¸ã§å¿ƒã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã‚ˆã†ã€‚", breath: { name: "æ¸…ã€…å‘¼å¸", guide: "å¸ã£ã¦æ–°é®®ã•ã‚’å–ã‚Šè¾¼ã¿ã€åã„ã¦å…¨èº«ã«å·¡ã‚‰ã›ã‚ˆã†ã€‚" } },
  { keyword: "å¸Œæœ›ã®å¾ªç’°", message: "å¸Œæœ›ã‚’å‘¼å¸ã§å¾ªç’°ã•ã›ã€é€±ã‚’å§‹ã‚ã‚ˆã†ã€‚", breath: { name: "å¸Œæœ›å¾ªç’°å‘¼å¸", guide: "å¸ã£ã¦å¸Œæœ›ã‚’å–ã‚Šè¾¼ã¿ã€åã„ã¦åºƒã’ã‚ˆã†ã€‚" } }
];

// =======================
// é€±ç•ªå·å–å¾—é–¢æ•°
// =======================
function getWeekMessage() {
  const now = new Date();
  const oneJan = new Date(now.getFullYear(), 0, 1);
  const week = Math.ceil(((now - oneJan) / 86400000 + oneJan.getDay() + 1) / 7);
  return weeklyMessages[(week - 1) % weeklyMessages.length];
}

// =======================
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€±æ¬¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
// =======================
async function sendWeeklyMessage(userId) {
  const trend = getWeekMessage();
  const text = `â˜€ï¸ ãŠã¯ã‚ˆã†  
ä»Šé€±ã®Yujã®é¢¨ã¯ã€Œ${trend.keyword}ã€ã ã‚ˆã€‚  
${trend.message}  

ðŸŒ¬ï¸ ${trend.breath.name}  
${trend.breath.guide}  

ä»Šé€±ã‚‚å‘¼å¸ã‹ã‚‰å§‹ã‚ã‚ˆã†ðŸŒ¿`;

  await axios.post(
    "https://api.line.me/v2/bot/message/push",
    {
      to: userId,
      messages: [{ type: "text", text }],
    },
    { headers: { Authorization: `Bearer ${LINE_ACCESS_TOKEN}` } }
  );
}

// =======================
// Webhookå—ä¿¡
// =======================
app.post("/webhook", async (req, res) => {
  res.sendStatus(200);

  try {
    for (const event of req.body.events) {
      if (event.type !== "message" || event.message.type !== "text") continue;

      const userMessage = event.message.text.trim();
      const userId = event.source.userId;
      const users = JSON.parse(fs.readFileSync(USERS_FILE, "utf-8"));

      // ðŸ’Ž åˆè¨€è‘‰èªè¨¼ã‚„ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ãªã©ã®æ—¢å­˜å‡¦ç†ã¯ã“ã“ã«ãã®ã¾ã¾å…¥ã‚Œã‚‹

      // ðŸ”¸ã€Œãƒ¨ã‚¬ã€ã¾ãŸã¯ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€å…¥åŠ›ã§ãƒœã‚¿ãƒ³è¡¨ç¤º
      if (["ãƒ¨ã‚¬", "ãƒ¡ãƒ‹ãƒ¥ãƒ¼"].includes(userMessage)) {
        await reply(event.replyToken, [
          {
            type: "template",
            altText: "ãƒ¨ã‚¬ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„",
            template: {
              type: "buttons",
              thumbnailImageUrl:
                "https://cdn.pixabay.com/photo/2017/08/06/06/47/yoga-2587066_1280.jpg",
              title: "ðŸ§˜â€â™€ï¸ Yuj Yoga Menu",
              text: "ä»Šæ—¥ã®æ°—åˆ†ã«åˆã‚ã›ã¦é¸ã‚“ã§ã­â™ª",
              actions: [
                { type: "message", label: "ðŸŒ… æœãƒ¨ã‚¬", text: "æœãƒ¨ã‚¬" },
                { type: "message", label: "ðŸŒ™ å¤œãƒªãƒ©ãƒƒã‚¯ã‚¹", text: "å¤œãƒªãƒ©ãƒƒã‚¯ã‚¹" },
                { type: "message", label: "ðŸ’ª è‚©ã“ã‚Šæ”¹å–„", text: "è‚©ã“ã‚Š" },
                { type: "message", label: "ðŸ§˜â€â™€ï¸ ã‚¹ãƒˆãƒ¬ã‚¹ã‚±ã‚¢", text: "ã‚¹ãƒˆãƒ¬ã‚¹" },
              ],
            },
          },
        ]);
        continue;
      }

      // ðŸŽ¯ ä»Šæ—¥ã®ã²ã¨ã“ã¨
      if (userMessage === "ä»Šæ—¥ã®ã²ã¨ã“ã¨") {
        const messages = [
          "ðŸŒ¿ æ·±å‘¼å¸ã—ã¦ã€å¿ƒã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
          "ðŸŒ¸ ã§ããªã„æ—¥ãŒã‚ã£ã¦ã‚‚å¤§ä¸ˆå¤«ã€‚ç¶šã‘ã‚‹ã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚",
          "ðŸŒž ã‚ãªãŸã®ãƒšãƒ¼ã‚¹ã§é€²ã‚ã°ã€ãã‚Œã§ååˆ†ã€‚",
          "ðŸª· ä»Šæ—¥ã‚‚å°ã•ãªä¸€æ­©ã‚’å¤§åˆ‡ã«ã—ã¦ã­ã€‚",
          "ðŸ’« ä»Šã®ã‚ãªãŸã¯ã€ã‚‚ã†ååˆ†é ‘å¼µã£ã¦ã„ã¾ã™ã€‚",
        ];
        const randomMessage = messages[Math.floor(Math.random() * messages.length)];
        await reply(event.replyToken, [{ type: "text", text: `ä»Šæ—¥ã®ã²ã¨ã“ã¨ ðŸŒ¿\n\n${randomMessage}` }]);
        continue;
      }

      // ðŸ”¹ AIå¿œç­”ï¼ˆChatGPTï¼‰
      let systemPrompt =
        "ã‚ãªãŸã¯å„ªã—ã„ãƒ¨ã‚¬ã‚¤ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã§ã™ã€‚åˆå¿ƒè€…ã«ã‚‚ã‚ã‹ã‚Šã‚„ã™ãã€å¿ƒãŒè½ã¡ç€ãè¨€è‘‰ã§ç­”ãˆã¦ãã ã•ã„ã€‚";

      // ç°¡æ˜“åˆ¤å®š
      if (userMessage.includes("æœ")) systemPrompt += " æœã®ãƒ¨ã‚¬ã‚’çŸ­ã„ã‚¹ãƒ†ãƒƒãƒ—å½¢å¼ã§3ï½ž5åˆ†ä»¥å†…ã§ã§ãã‚‹ã‚ˆã†ã«ã€æ•°å­—ã‚„ç§’æ•°ã‚‚å…¥ã‚Œã¦èª¬æ˜Žã—ã¦ãã ã•ã„ã€‚";
      else if (userMessage.includes("å¤œ")) systemPrompt += "å¤œã®ãƒªãƒ©ãƒƒã‚¯ã‚¹ãƒ¨ã‚¬ã‚’çŸ­ã„ã‚¹ãƒ†ãƒƒãƒ—å½¢å¼ã§3ï½ž5åˆ†ä»¥å†…ã§ã§ãã‚‹ã‚ˆã†ã«ã€æ•°å­—ã‚„ç§’æ•°ã‚‚å…¥ã‚Œã¦èª¬æ˜Žã—ã¦ãã ã•ã„ã€‚";
      else if (userMessage.includes("è‚©")) systemPrompt += " è‚©ã“ã‚Šã«åŠ¹æžœçš„ãªãƒ¨ã‚¬ãƒãƒ¼ã‚ºã‚’çŸ­ã„ã‚¹ãƒ†ãƒƒãƒ—å½¢å¼ã§3ï½ž5åˆ†ä»¥å†…ã§ã§ãã‚‹ã‚ˆã†ã«ã€æ•°å­—ã‚„ç§’æ•°ã‚‚å…¥ã‚Œã¦èª¬æ˜Žã—ã¦ãã ã•ã„ã€‚";
      else if (userMessage.includes("ã‚¹ãƒˆãƒ¬ã‚¹")) systemPrompt += " ã‚¹ãƒˆãƒ¬ã‚¹ã‚’ã‚„ã‚ã‚‰ã’ã‚‹å‘¼å¸æ³•ã‚„ãƒãƒ¼ã‚ºã‚’ç´¹ä»‹ã—ã¦ãã ã•ã„ã€‚";
      else systemPrompt += " ãã®å†…å®¹ã«åˆã‚ã›ãŸå‰å‘ããªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’çŸ­ãä¼ãˆã¦ãã ã•ã„ã€‚";

      const aiResponse = await axios.post(
        "https://api.openai.com/v1/chat/completions",
        {
          model: "gpt-4o-mini",
          messages: [
            { role: "system", content: systemPrompt },
            { role: "user", content: userMessage },
          ],
        },
        { headers: { Authorization: `Bearer ${OPENAI_API_KEY}`, "Content-Type": "application/json" } }
      );

      await reply(event.replyToken, [{ type: "text", text: aiResponse.data.choices[0].message.content }]);
    }
  } catch (error) {
    console.error("ã‚¨ãƒ©ãƒ¼:", error.response?.data || error.message);
  }
});

// =======================
// å…±é€šè¿”ä¿¡é–¢æ•°
// =======================
async function reply(replyToken, messages) {
  await axios.post(
    "https://api.line.me/v2/bot/message/reply",
    { replyToken, messages },
    { headers: { "Content-Type": "application/json", Authorization: `Bearer ${LINE_ACCESS_TOKEN}` } }
  );
}

// =======================
// é€±æ¬¡é…ä¿¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆç®¡ç†è€…ç”¨ï¼‰
// =======================
app.get("/weekly-task", async (req, res) => {
  if (req.query.key !== ADMIN_SECRET) return res.status(403).send("Unauthorized");

  try {
    const users = JSON.parse(fs.readFileSync(USERS_FILE, "utf-8"));
    for (const userId in users) {
      if (users[userId].isPaid) {
        await sendWeeklyMessage(userId);
      }
    }
    res.send("âœ… é€±æ¬¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚");
  } catch (error) {
    console.error(error);
    res.status(500).send("ðŸš¨ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
  }
});

// =======================
// å‹•ä½œç¢ºèª
// =======================
app.get("/", (req, res) => res.send("Yuj Bot is running ðŸ§˜â€â™€ï¸"));

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`âœ… Yuj Bot is running on port ${PORT}`));

